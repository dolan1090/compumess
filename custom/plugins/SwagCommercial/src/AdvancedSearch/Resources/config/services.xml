<?xml version="1.0" ?>

<container xmlns="http://symfony.com/schema/dic/services"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

    <imports>
        <import resource="./boostings.xml"/>
    </imports>

    <parameters>
        <parameter key="advanced_search.index.config" type="collection">
            <parameter key="settings" type="collection">
                <parameter key="analysis">%advanced_search.analysis%</parameter>
            </parameter>
        </parameter>
    </parameters>

    <services>
        <service id="Shopware\Commercial\AdvancedSearch\Entity\AdvancedSearchConfig\AdvancedSearchConfigDefinition">
            <tag name="shopware.entity.definition"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Entity\AdvancedSearchConfig\Aggregate\AdvancedSearchConfigFieldDefinition">
            <tag name="shopware.entity.definition"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Elasticsearch\ElasticsearchHelperDecorator"
                 decorates="Shopware\Elasticsearch\Framework\ElasticsearchHelper">
            <argument type="service" id=".inner"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Configuration\ConfigurationLoader"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Elasticsearch\ProductSearchBuilderDisabler"
                 decorates="Shopware\Core\Content\Product\SearchKeyword\ProductSearchBuilderInterface"
                 decoration-priority="-60000">
            <argument type="service" id=".inner"/>
            <argument type="service" id="Shopware\Elasticsearch\Framework\ElasticsearchHelper"/>
            <argument type="service" id="Shopware\Core\Content\Product\ProductDefinition"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Subscriber\SalesChannelCreatedSubscriber">
            <argument type="service" id="Doctrine\DBAL\Connection"/>

            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Indexing\ElasticsearchIndexConfigSubscriber">
            <argument>%advanced_search.index.config%</argument>

            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Search\TokenQueryBuilder">
            <argument type="service" id="Shopware\Core\Framework\DataAbstractionLayer\Dbal\EntityDefinitionQueryHelper" />
            <argument type="service" id="Shopware\Core\System\CustomField\CustomFieldService" />
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Search\SearchLogic">
            <argument type="service" id="Shopware\Elasticsearch\Product\StopwordTokenFilter"/>
            <argument type="service" id="Shopware\Core\Framework\DataAbstractionLayer\Search\Term\Tokenizer"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Configuration\ConfigurationLoader"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Search\TokenQueryBuilder"/>
            <argument>%advanced_search.cross_search%</argument>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\CrossSearch\Converter\ProductCategoryCrossSearchConverter">
            <tag name="advanced_search.cross_search.converter"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\CrossSearch\Converter\ProductManufacturerCrossSearchConverter">
            <tag name="advanced_search.cross_search.converter"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\CrossSearch\Converter\CategoryProductCrossSearchConverter">
            <tag name="advanced_search.cross_search.converter"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\CrossSearch\Converter\ManufacturerProductCrossSearchConverter">
            <tag name="advanced_search.cross_search.converter"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\CrossSearch\CrossSearchLogic">
            <argument type="service" id="Shopware\Elasticsearch\Product\StopwordTokenFilter"/>
            <argument type="service" id="Shopware\Core\Framework\DataAbstractionLayer\Search\Term\Tokenizer"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Configuration\ConfigurationLoader"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Search\TokenQueryBuilder"/>
            <argument type="service" id="OpenSearch\Client"/>
            <argument type="service" id="Shopware\Elasticsearch\Framework\ElasticsearchHelper"/>
            <argument type="tagged" tag="advanced_search.cross_search.converter" />
            <argument>%advanced_search.cross_search%</argument>
            <argument>%elasticsearch.search.timeout%</argument>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Indexing\ElasticsearchDefinition\Product\ElasticsearchProductDefinitionDecorator" decorates="Shopware\Elasticsearch\Product\ElasticsearchProductDefinition">
            <argument type="service" id=".inner"/>
            <argument type="service" id="Doctrine\DBAL\Connection"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Search\SearchLogic"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\CrossSearch\CrossSearchLogic"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Completion\CompletionDefinitionEnrichment"/>
            <argument>%advanced_search.language_analyzer_mapping%</argument>

            <tag name="advanced_search.supported_definition"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Indexing\ElasticsearchDefinition\Manufacturer\ManufacturerElasticsearchDefinition">
            <argument type="service" id="Shopware\Core\Content\Product\Aggregate\ProductManufacturer\ProductManufacturerDefinition"/>
            <argument type="service" id="Doctrine\DBAL\Connection"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Search\SearchLogic"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\CrossSearch\CrossSearchLogic"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Completion\CompletionDefinitionEnrichment"/>
            <argument>%advanced_search.language_analyzer_mapping%</argument>

            <tag name="shopware.es.definition"/>
            <tag name="advanced_search.supported_definition"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Indexing\ElasticsearchDefinition\Category\CategoryElasticsearchDefinition">
            <argument type="service" id="Shopware\Core\Content\Category\CategoryDefinition"/>
            <argument type="service" id="Doctrine\DBAL\Connection"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Search\SearchLogic"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\CrossSearch\CrossSearchLogic"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Completion\CompletionDefinitionEnrichment"/>
            <argument>%advanced_search.language_analyzer_mapping%</argument>

            <tag name="shopware.es.definition"/>
            <tag name="advanced_search.supported_definition"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Entity\CategoryExtension">
            <tag name="shopware.entity.extension"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Entity\ManufacturerExtension">
            <tag name="shopware.entity.extension"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Entity\ProductExtension">
            <tag name="shopware.entity.extension"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Search\ProductSearchRouteDecorator"
                 decorates="Shopware\Core\Content\Product\SalesChannel\Search\ProductSearchRoute"
                 decoration-priority="-60000">
            <argument type="service" id=".inner"/>
            <argument type="tagged" tag="advanced_search.supported_definition"/>
            <argument type="service" id="event_dispatcher"/>
            <argument type="service" id="Shopware\Core\Framework\DataAbstractionLayer\DefinitionInstanceRegistry"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Search\SearchTermExtractor"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Configuration\ConfigurationLoader"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Boosting\BoostingQueryBuilder"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Suggest\ProductSuggestRouteDecorator"
                 decorates="Shopware\Core\Content\Product\SalesChannel\Suggest\ProductSuggestRoute"
                 decoration-priority="-60000">
            <argument type="service" id=".inner"/>
            <argument type="tagged" tag="advanced_search.supported_definition"/>
            <argument type="service" id="event_dispatcher"/>
            <argument type="service" id="Shopware\Core\Framework\DataAbstractionLayer\DefinitionInstanceRegistry"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Search\SearchTermExtractor"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Configuration\ConfigurationLoader"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Completion\CompletionSearcher"/>
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\Boosting\BoostingQueryBuilder"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Completion\CompletionSearcher">
            <argument type="service" id="OpenSearch\Client"/>
            <argument type="tagged" tag="shopware.es.definition"/>
            <argument type="service" id="Shopware\Elasticsearch\Framework\ElasticsearchHelper"/>
            <argument>%elasticsearch.search.timeout%</argument>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Completion\CompletionDefinitionEnrichment">
            <argument>%advanced_search.completion%</argument>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\PreviewSearch\PreviewSearchService" public="true">
            <argument type="service" id="Shopware\Core\Content\Product\SalesChannel\Search\ProductSearchRoute"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Api\PreviewSearchController" public="true">
            <argument type="service" id="Shopware\Commercial\AdvancedSearch\Domain\PreviewSearch\PreviewSearchService"/>
            <argument type="service" id="Shopware\Core\System\SalesChannel\Context\SalesChannelContextFactory"/>
            <argument type="service" id="Shopware\Core\Framework\DataAbstractionLayer\DefinitionInstanceRegistry"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Subscriber\CategorySearchCriteriaSubscriber">
            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Subscriber\CategoryUpdater">
            <argument type="service" id="Shopware\Elasticsearch\Framework\Indexing\ElasticsearchIndexer"/>
            <argument type="service" id="Shopware\Core\Content\Category\CategoryDefinition"/>

            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Subscriber\ManufacturerUpdater">
            <argument type="service" id="Shopware\Elasticsearch\Framework\Indexing\ElasticsearchIndexer"/>
            <argument type="service" id="Shopware\Core\Content\Product\Aggregate\ProductManufacturer\ProductManufacturerDefinition"/>

            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Configuration\ConfigurationLoader">
            <argument type="service" id="Doctrine\DBAL\Connection"/>

            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Domain\Search\SearchTermExtractor">
            <argument>%elasticsearch.search.term_max_length%</argument>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Cache\CacheInvalidationSubscriber">
            <argument type="service" id="Shopware\Core\Framework\Adapter\Cache\CacheInvalidator"/>

            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Elasticsearch\SearchKeywordReplacement"
                 decorates="Shopware\Core\Content\Product\DataAbstractionLayer\SearchKeywordUpdater"
                 decoration-priority="-60000">

            <argument type="service" id="Shopware\Elasticsearch\Product\SearchKeywordReplacement.inner"/>
            <argument type="service" id="Shopware\Elasticsearch\Framework\ElasticsearchHelper"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Subscriber\ProductCustomFieldsMappingEventSubscriber">
            <argument type="service" id="Doctrine\DBAL\Connection"/>

            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Subscriber\ElasticsearchEntitySearcherSubscriber">
            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="Shopware\Commercial\AdvancedSearch\Subscriber\BoostingDeletionSubscriber">
            <argument type="service" id="Doctrine\DBAL\Connection"/>

            <tag name="kernel.event_subscriber"/>
        </service>

    </services>
</container>
