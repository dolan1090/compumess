{% sw_extends '@Storefront/storefront/component/line-item/line-item.html.twig' %}

{% set CUSTOMIZED_PRODUCTS_TEMPLATE_LINE_ITEM_TYPE = constant('Swag\\CustomizedProducts\\Core\\Checkout\\CustomizedProductsCartDataCollector::CUSTOMIZED_PRODUCTS_TEMPLATE_LINE_ITEM_TYPE') %}
{% set CUSTOMIZED_PRODUCTS_OPTION_LINE_ITEM_TYPE = constant('Swag\\CustomizedProducts\\Core\\Checkout\\CustomizedProductsCartDataCollector::CUSTOMIZED_PRODUCTS_OPTION_LINE_ITEM_TYPE') %}
{% set PRODUCT_LINE_ITEM_TYPE = constant('Shopware\\Core\\Checkout\\Cart\\LineItem\\LineItem::PRODUCT_LINE_ITEM_TYPE') %}
{% set isCustomizedProduct = lineItem.type == CUSTOMIZED_PRODUCTS_TEMPLATE_LINE_ITEM_TYPE %}
{% set isCustomizedProductOption = lineItem.type == CUSTOMIZED_PRODUCTS_OPTION_LINE_ITEM_TYPE %}
{% set cover, label, mainLineItem = null, null, null %}

{% block component_line_item %}
    {% if isCustomizedProduct %}
        {% for key,child in lineItem.children %}
            {% if child.type == PRODUCT_LINE_ITEM_TYPE %}
                {% set label = child.label %}
                {% set referencedId = child.referencedId %}
                {% set productNumber = lineItem.payload|merge({ 'productNumber': child.payload.productNumber }) %}

                {% if child.cover.url %}
                    {% set cover = child.cover %}
                {% endif %}

                {% do lineItem.setLabel(label) %}
                {% do lineItem.setCover(cover) %}
                {% do lineItem.setReferencedId(referencedId) %}
                {% do lineItem.setPayload(productNumber) %}

                {% do lineItem.children.remove(key) %}
            {% endif %}
        {% endfor %}
        {% sw_include '@SwagCustomizedProducts/storefront/component/line-item/type/custom-product.html.twig' with {
            lineItem: lineItem
        } %}
    {% else %}
        {{ parent() }}
    {% endif %}
{% endblock %}
