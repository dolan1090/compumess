variables:
  PLATFORM_MIN_VERSION: '6.5.0.0'
  STOREFRONT_CYPRESS_SPEC: 'cypress/integration/**/*'
  ADMIN_CYPRESS_SPEC: 'cypress/integration/**/*'

  PLUGIN_DEPENDENCIES:
    value: >
      [
        { "name": "SwagMigrationAssistant", "url": "gitlab.shopware.com/shopware/6/services/migration-assistant", "branch": "master" },
        { "name": "SwagPayPal", "url": "gitlab.shopware.com/shopware/6/services/paypal", "branch": "master" }
      ]
    description: 'Plugin dependencies. Defined in json. Example: [{ "name": "SwagPayPal", "url": "gitlab.shopware.com/shopware/6/services/paypal", "branch": "master" }]'

#phpunit:
#  parallel:
#    matrix:
#      -   MYSQL_IMAGE: mariadb:10.4
#          PLATFORM_BRANCH: [ $PLATFORM_MIN_VERSION, 'trunk' ]
#      -   MYSQL_IMAGE:
#            - mysql:5.7
#            - mariadb:10.3
#          PLATFORM_BRANCH: [ $PLATFORM_MIN_VERSION, 'trunk' ]
#      -   MYSQL_IMAGE:
#            - mysql:8.0.19
#          PLATFORM_BRANCH: [ $PLATFORM_MIN_VERSION, 'trunk' ]
#          MYSQL_CMD: $MYSQL8_CMD


phpstan:
  script:
    - composer dump-autoload --dev
    - >
      if [[ -r tests/TestBootstrap.php ]]; then
          php tests/TestBootstrap.php
      fi
    - composer phpstan -- --error-format=gitlab --no-progress | tee ${CI_PROJECT_DIR}/phpstan-report.json

jest (storefront):
  when: manual

jest (administration):
  script:
    - '(cd $ADMIN_PATH && npm ci)'
    - $CI_PROJECT_DIR/bin/console framework:schema -s 'entity-schema' $ADMIN_PATH/test/_mocks_/entity-schema.json
    - cd ${PLUGIN_SOURCE_DIR}Resources/app/administration/
    - npm ci
    - npm run unit

include:
  project: 'shopware/6/product/platform'
  ref: 'trunk'
  file: '.gitlab/templates/plugin.yml'

cypress storefront:
  script:
    - $CI_PROJECT_DIR/bin/console feature:dump
    - !reference [ .e2e-prepare ]
    - APP_ENV=e2e ./node_modules/.bin/cypress run --browser $BROWSER --headless --spec "$CYPRESS_SPEC"
